
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‚ö° –°–∫–æ—Ä–æ—Å—Ç–Ω–∞—è –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ ‚ö°</title>
  <style>
    :root {
      --bg: #0b0c0e;
      --fg: #e2e8f0;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --card: #111318;
      --danger: #ef4444;
      --ok: #10b981;
      --border: #1f2937;
    }
    [data-theme="light"]{
      --bg: #ffffff;
      --fg: #0b0c0e;
      --muted: #374151;
      --accent: #2563eb;
      --card: #f3f4f6;
      --danger: #b91c1c;
      --ok: #059669;
      --border: #e5e7eb;
    }
    *{box-sizing: border-box}
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 5;
    }
    .brand {
      font-weight: 800;
      letter-spacing: .3px;
      font-size: clamp(18px, 2.4vw, 26px);
    }
    .brand .bolt{ filter: drop-shadow(0 0 4px var(--accent)); }
    .header-actions {
      display: flex; gap: 10px; align-items: center;
    }
    .btn {
      padding: 8px 12px;
      background: transparent;
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      font-size: 14px;
    }
    .btn:hover { background: color-mix(in oklab, var(--accent) 12%, var(--bg)); border-color: var(--accent) }
    .btn:active { transform: translateY(1px) }
    .btn.primary { background: var(--accent); color: #000; border-color: var(--accent) }
    .btn.ghost { background: transparent; border-color: var(--border) }
    .btn.small{ font-size: 12px; padding: 6px 9px; border-radius: 8px }
    .tag {
      font-size: 11px; padding: 2px 6px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted)
    }
    main {
      width: min(1100px, 92vw);
      margin: 22px auto;
      flex: 1;
      display: grid;
      gap: 18px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.15);
    }
    .grid {
      display: grid; gap: 16px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px){
      .grid { grid-template-columns: 1.2fr .8fr; }
    }
    .mode-list{ display: grid; gap: 12px; }
    .mode {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      padding: 14px; border-radius: 12px; border: 1px dashed var(--border);
    }
    .mode h3 { margin: 0 0 6px 0; font-size: 18px }
    .mode p { margin: 0; color: var(--muted); font-size: 14px }
    .muted { color: var(--muted) }
    table { width: 100%; border-collapse: collapse; font-size: 14px }
    th, td { padding: 8px 10px; border-bottom: 1px dashed var(--border); text-align: left }
    th { color: var(--muted); font-weight: 600; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .center { text-align: center }
    .stack { display: grid; gap: 10px }
    .row { display:flex; align-items:center; gap:10px; flex-wrap: wrap }
    .field { display: grid; gap: 6px }
    input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg);
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
    }
    .game-area { display: grid; gap: 12px; justify-items: center; text-align: center }
    .big { font-size: clamp(22px, 4vw, 36px); font-weight: 700 }
    .xxl { font-size: clamp(26px, 6vw, 48px); font-weight: 800 }
    .warn { color: var(--danger) }
    .ok { color: var(--ok) }

    /* Settings button bottom-left */
    .settings-fab {
      position: fixed;
      left: 14px;
      bottom: 14px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      z-index: 6;
      opacity: .9;
    }

    /* Modal */
    .modal {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.45);
      z-index: 10;
      padding: 20px;
    }
    .modal.show { display: flex }
    .modal .panel {
      width: min(560px, 96vw);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
    }
    .panel h3 { margin: 0 0 10px 0 }
    .panel .footer { display:flex; justify-content: flex-end; gap:10px; margin-top: 14px }

    /* Hover tooltip for difficulty */
    .tooltip {
      position: relative; cursor: default;
    }
    .tooltip:hover::after {
      content: attr(data-tip);
      position: absolute; left: 0; top: calc(100% + 6px);
      background: var(--card); color: var(--fg);
      border: 1px solid var(--border); border-radius: 10px;
      padding: 8px 10px; width: max-content; max-width: 320px; white-space: normal;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      z-index: 3;
    }
    footer{
      border-top: 1px solid var(--border);
      padding: 12px 18px;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="brand"><span class="bolt">‚ö°</span> <span data-i18n="app_title">–°–∫–æ—Ä–æ—Å—Ç–Ω–∞—è –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</span></div>
    <div class="header-actions">
      <span id="userTag" class="tag">–ì–æ—Å—Ç—å</span>
      <button id="authBtn" class="btn small">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    </div>
  </header>

  <main>
    <!-- HOME (mode select) -->
    <section id="homeView" class="grid">
      <div class="card">
        <h2 style="margin-top:0" data-i18n="choose_mode_title">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º</h2>
        <div class="mode-list">
          <div class="mode">
            <div>
              <h3 data-i18n="mode_pow_title">–°–∫–æ—Ä–æ—Å—Ç–Ω–æ–µ –≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å</h3>
              <p class="muted" data-i18n="mode_pow_desc">–ë—ã—Å—Ç—Ä–æ —Ä–µ—à–∞–π—Ç–µ —Å—Ç–µ–ø–µ–Ω–∏ ‚Äî –Ω–∞ –≤—Ä–µ–º—è –∏ —Ç–æ—á–Ω–æ—Å—Ç—å.</p>
            </div>
            <button class="btn primary" id="openPowMode" data-i18n="play">–ò–≥—Ä–∞—Ç—å</button>
          </div>

          <!-- –ü—Ä–∏–º–µ—Ä –¥—Ä—É–≥–∏—Ö —Ä–µ–∂–∏–º–æ–≤ –Ω–∞ –±—É–¥—É—â–µ–µ -->
          <div class="mode">
            <div>
              <h3 data-i18n="mode_coming">–î—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã (—Å–∫–æ—Ä–æ)</h3>
              <p class="muted" data-i18n="mode_coming_desc">–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è, –∫–æ—Ä–Ω–∏, —Å–º–µ—à–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –∏ –¥—Ä.</p>
            </div>
            <button class="btn ghost" disabled data-i18n="coming_soon">–°–∫–æ—Ä–æ</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 style="margin-top:0" data-i18n="best_scores_title">–õ—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç—è–º</h2>
        <table id="bestTable">
          <thead>
            <tr>
              <th data-i18n="difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
              <th class="center" data-i18n="best_score">–†–µ–∫–æ—Ä–¥</th>
              <th class="center" data-i18n="by_user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            </tr>
          </thead>
          <tbody>
            <!-- filled by JS -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- POWER MODE -->
    <section id="powView" class="card" style="display:none">
      <div class="row" style="justify-content: space-between">
        <div class="row">
          <button class="btn small" id="backHome">‚Üê <span data-i18n="back">–ù–∞–∑–∞–¥</span></button>
          <span class="tag" id="currentDiffTag">‚Äî</span>
        </div>
        <div class="row">
          <div class="field" style="min-width:200px">
            <label for="timeLimit" class="muted" data-i18n="time_per_q">–í—Ä–µ–º—è –Ω–∞ –≤–æ–ø—Ä–æ—Å (—Å–µ–∫)</label>
            <input id="timeLimit" type="number" min="1" value="20" />
          </div>
        </div>
      </div>

      <div class="row" style="justify-content:center; margin-top:10px">
        <div class="field" style="min-width:260px">
          <label class="muted tooltip" id="difficultyLabel" data-tip="">üîß <span data-i18n="choose_difficulty">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</span></label>
          <select id="difficulty">
            <option value="very_easy" data-tip="1‚Äì10 ^ 2" data-i18n="d_very_easy">–û—á–µ–Ω—å –ª–µ–≥–∫–æ</option>
            <option value="easy" data-tip="1‚Äì10 ^ {2,3,4}" data-i18n="d_easy">–õ–µ–≥–∫–æ</option>
            <option value="medium" data-tip="1‚Äì10 ^ 2‚Ä¶10" data-i18n="d_medium">–°—Ä–µ–¥–Ω–µ</option>
            <option value="hard" data-tip="1‚Äì20 ^ 2‚Ä¶10" data-i18n="d_hard">–°–ª–æ–∂–Ω–æ</option>
            <option value="very_hard" data-tip="10‚Äì100 ^ 2‚Ä¶100" data-i18n="d_very_hard">–û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ</option>
            <option value="impossible" data-tip="100‚Äì999 ^ 2‚Ä¶100" data-i18n="d_impossible">–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ</option>
          </select>
        </div>
        <button class="btn primary" id="startBtn" style="min-width:140px" data-i18n="start_game">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      </div>

      <div class="game-area" style="margin-top:16px">
        <div id="question" class="xxl">‚Äî</div>
        <input id="answer" class="mono" type="number" inputmode="numeric" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç‚Ä¶" style="max-width:260px" disabled />
        <div class="row">
          <div id="timer" class="tag">‚è± 0.0s</div>
          <div id="score" class="tag">0</div>
        </div>
        <div id="message" class="muted"></div>
      </div>
    </section>
  </main>

  <button class="btn settings-fab" id="openSettings">‚öô <span data-i18n="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>

  <footer class="center">
    <span class="muted">¬© <span id="year"></span> ‚Ä¢ <span data-i18n="app_title">–°–∫–æ—Ä–æ—Å—Ç–Ω–∞—è –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</span></span>
  </footer>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="panel">
      <h3 style="margin-top:0">‚öô <span data-i18n="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div class="field">
          <label class="muted" for="language" data-i18n="language">–Ø–∑—ã–∫</label>
          <select id="language">
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="zh">‰∏≠Êñá</option>
            <option value="ja">Êó•Êú¨Ë™û</option>
            <option value="fr">Fran√ßais</option>
            <option value="es">Espa√±ol</option>
            <option value="pt">Portugu√™s</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
          </select>
        </div>
        <div class="field">
          <label class="muted" for="theme" data-i18n="theme">–¢–µ–º–∞</label>
          <select id="theme">
            <option value="dark" data-i18n="dark">–¢—ë–º–Ω–∞—è</option>
            <option value="light" data-i18n="light">–°–≤–µ—Ç–ª–∞—è</option>
          </select>
        </div>
      </div>
      <div class="footer">
        <button class="btn ghost" id="closeSettings" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn primary" id="saveSettings" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    /************ 1) FIREBASE SETUP ************/
    // ‚õ≥ –í–ê–ñ–ù–û: –∑–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∏–∂–µ –Ω–∞ —Å–≤–æ–∏ –∏–∑ Firebase Console (Project Settings ‚Üí General ‚Üí Your apps).
    // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –ù–ï —è–≤–ª—è–µ—Ç—Å—è —Å–µ–∫—Ä–µ—Ç–æ–º, –µ—ë –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ HTML.
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    /************ 2) I18N ************/
    const i18n = {
      ru: {
        app_title: "–°–∫–æ—Ä–æ—Å—Ç–Ω–∞—è –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞",
        settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
        language: "–Ø–∑—ã–∫",
        theme: "–¢–µ–º–∞",
        light: "–°–≤–µ—Ç–ª–∞—è",
        dark: "–¢—ë–º–Ω–∞—è",
        save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
        cancel: "–û—Ç–º–µ–Ω–∞",
        choose_mode_title: "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º",
        mode_pow_title: "–°–∫–æ—Ä–æ—Å—Ç–Ω–æ–µ –≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å",
        mode_pow_desc: "–ë—ã—Å—Ç—Ä–æ —Ä–µ—à–∞–π—Ç–µ —Å—Ç–µ–ø–µ–Ω–∏ ‚Äî –Ω–∞ –≤—Ä–µ–º—è –∏ —Ç–æ—á–Ω–æ—Å—Ç—å.",
        mode_coming: "–î—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã (—Å–∫–æ—Ä–æ)",
        mode_coming_desc: "–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è, –∫–æ—Ä–Ω–∏, —Å–º–µ—à–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –∏ –¥—Ä.",
        coming_soon: "–°–∫–æ—Ä–æ",
        play: "–ò–≥—Ä–∞—Ç—å",
        best_scores_title: "–õ—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç—è–º",
        difficulty: "–°–ª–æ–∂–Ω–æ—Å—Ç—å",
        best_score: "–†–µ–∫–æ—Ä–¥",
        by_user: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
        back: "–ù–∞–∑–∞–¥",
        time_per_q: "–í—Ä–µ–º—è –Ω–∞ –≤–æ–ø—Ä–æ—Å (—Å–µ–∫)",
        choose_difficulty: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å",
        d_very_easy: "–û—á–µ–Ω—å –ª–µ–≥–∫–æ",
        d_easy: "–õ–µ–≥–∫–æ",
        d_medium: "–°—Ä–µ–¥–Ω–µ",
        d_hard: "–°–ª–æ–∂–Ω–æ",
        d_very_hard: "–û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ",
        d_impossible: "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ",
        start_game: "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É",
        guest: "–ì–æ—Å—Ç—å",
        sign_in: "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google",
        sign_out: "–í—ã–π—Ç–∏",
        correct: "–í–µ—Ä–Ω–æ!",
        wrong: "–ù–µ–≤–µ—Ä–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ",
        time_up: "–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ",
        game_over: "–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞",
        record_saved: "–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!"
      },
      en: {
        app_title: "Speed Math",
        settings: "Settings",
        language: "Language",
        theme: "Theme",
        light: "Light",
        dark: "Dark",
        save: "Save",
        cancel: "Cancel",
        choose_mode_title: "Choose a mode",
        mode_pow_title: "Rapid Exponentiation",
        mode_pow_desc: "Solve powers fast ‚Äî against the clock.",
        mode_coming: "More modes (soon)",
        mode_coming_desc: "Multiplication table, roots, mixed drills, and more.",
        coming_soon: "Soon",
        play: "Play",
        best_scores_title: "Best scores by difficulty",
        difficulty: "Difficulty",
        best_score: "Best",
        by_user: "User",
        back: "Back",
        time_per_q: "Time per question (sec)",
        choose_difficulty: "Choose difficulty",
        d_very_easy: "Very Easy",
        d_easy: "Easy",
        d_medium: "Medium",
        d_hard: "Hard",
        d_very_hard: "Very Hard",
        d_impossible: "Impossible",
        start_game: "Start Game",
        guest: "Guest",
        sign_in: "Sign in with Google",
        sign_out: "Sign out",
        correct: "Correct!",
        wrong: "Wrong! Correct answer: ",
        time_up: "Time's up! Correct answer: ",
        game_over: "Game Over",
        record_saved: "New record saved!"
      },
      de: {
        app_title: "Schnellrechnen",
        settings: "Einstellungen",
        language: "Sprache",
        theme: "Thema",
        light: "Hell",
        dark: "Dunkel",
        save: "Speichern",
        cancel: "Abbrechen",
        choose_mode_title: "Modus w√§hlen",
        mode_pow_title: "Schnelles Potenzieren",
        mode_pow_desc: "Potenzen schnell l√∂sen ‚Äì gegen die Uhr.",
        mode_coming: "Weitere Modi (bald)",
        mode_coming_desc: "Einmaleins, Wurzeln, gemischte √úbungen usw.",
        coming_soon: "Bald",
        play: "Spielen",
        best_scores_title: "Bestwerte nach Schwierigkeit",
        difficulty: "Schwierigkeit",
        best_score: "Bestwert",
        by_user: "Benutzer",
        back: "Zur√ºck",
        time_per_q: "Zeit pro Frage (Sek.)",
        choose_difficulty: "Schwierigkeit w√§hlen",
        d_very_easy: "Sehr leicht",
        d_easy: "Leicht",
        d_medium: "Mittel",
        d_hard: "Schwer",
        d_very_hard: "Sehr schwer",
        d_impossible: "Unm√∂glich",
        start_game: "Spiel starten",
        guest: "Gast",
        sign_in: "Mit Google anmelden",
        sign_out: "Abmelden",
        correct: "Richtig!",
        wrong: "Falsch! Richtige Antwort: ",
        time_up: "Zeit abgelaufen! Richtige Antwort: ",
        game_over: "Spiel beendet",
        record_saved: "Neuer Rekord gespeichert!"
      },
      zh: {
        app_title: "ÊûÅÈÄüÊï∞Â≠¶",
        settings: "ËÆæÁΩÆ",
        language: "ËØ≠Ë®Ä",
        theme: "‰∏ªÈ¢ò",
        light: "ÊµÖËâ≤",
        dark: "Ê∑±Ëâ≤",
        save: "‰øùÂ≠ò",
        cancel: "ÂèñÊ∂à",
        choose_mode_title: "ÈÄâÊã©Ê®°Âºè",
        mode_pow_title: "Âø´ÈÄüÂπÇËøêÁÆó",
        mode_pow_desc: "‰∏éÊó∂Èó¥ËµõË∑ëÔºåÂø´ÈÄüËÆ°ÁÆóÂπÇ„ÄÇ",
        mode_coming: "Êõ¥Â§öÊ®°ÂºèÔºàÂç≥Â∞ÜÊé®Âá∫Ôºâ",
        mode_coming_desc: "‰πòÊ≥ïË°®„ÄÅÂºÄÊñπ„ÄÅÁªºÂêàÁªÉ‰π†Á≠â„ÄÇ",
        coming_soon: "Âç≥Â∞ÜÊé®Âá∫",
        play: "ÂºÄÂßã",
        best_scores_title: "ÂêÑÈöæÂ∫¶ÊúÄ‰Ω≥ÊàêÁª©",
        difficulty: "ÈöæÂ∫¶",
        best_score: "ÊúÄ‰Ω≥",
        by_user: "Áî®Êà∑",
        back: "ËøîÂõû",
        time_per_q: "ÊØèÈ¢òÊó∂Èó¥ÔºàÁßíÔºâ",
        choose_difficulty: "ÈÄâÊã©ÈöæÂ∫¶",
        d_very_easy: "ÈùûÂ∏∏ÂÆπÊòì",
        d_easy: "ÂÆπÊòì",
        d_medium: "‰∏≠Á≠â",
        d_hard: "Âõ∞Èöæ",
        d_very_hard: "ÈùûÂ∏∏Âõ∞Èöæ",
        d_impossible: "‰∏çÂèØËÉΩ",
        start_game: "ÂºÄÂßãÊ∏∏Êàè",
        guest: "Ê∏∏ÂÆ¢",
        sign_in: "‰ΩøÁî® Google ÁôªÂΩï",
        sign_out: "ÈÄÄÂá∫ÁôªÂΩï",
        correct: "Ê≠£Á°ÆÔºÅ",
        wrong: "ÈîôËØØÔºÅÊ≠£Á°ÆÁ≠îÊ°àÔºö",
        time_up: "Êó∂Èó¥Âà∞ÔºÅÊ≠£Á°ÆÁ≠îÊ°àÔºö",
        game_over: "Ê∏∏ÊàèÁªìÊùü",
        record_saved: "Êñ∞Á∫™ÂΩïÂ∑≤‰øùÂ≠òÔºÅ"
      },
      ja: {
        app_title: "„Çπ„Éî„Éº„ÉâÊï∞Â≠¶",
        settings: "Ë®≠ÂÆö",
        language: "Ë®ÄË™û",
        theme: "„ÉÜ„Éº„Éû",
        light: "„É©„Ç§„Éà",
        dark: "„ÉÄ„Éº„ÇØ",
        save: "‰øùÂ≠ò",
        cancel: "„Ç≠„É£„É≥„Çª„É´",
        choose_mode_title: "„É¢„Éº„Éâ„ÇíÈÅ∏Êäû",
        mode_pow_title: "È´òÈÄü„Åπ„Åç‰πó",
        mode_pow_desc: "ÊôÇÈñì„Å®„ÅÆÂãùË≤†„Åß„Åπ„Åç‰πó„ÇíËß£„Åè„ÄÇ",
        mode_coming: "‰ªñ„ÅÆ„É¢„Éº„ÉâÔºàËøëÊó•Ôºâ",
        mode_coming_desc: "‰πù‰πù„ÄÅÂπ≥ÊñπÊ†π„ÄÅ„Éü„ÉÉ„ÇØ„ÇπÂïèÈ°å„Å™„Å©„ÄÇ",
        coming_soon: "ËøëÊó•",
        play: "„Éó„É¨„Ç§",
        best_scores_title: "Èõ£ÊòìÂ∫¶Âà•„Éô„Çπ„Éà",
        difficulty: "Èõ£ÊòìÂ∫¶",
        best_score: "„Éô„Çπ„Éà",
        by_user: "„É¶„Éº„Ç∂„Éº",
        back: "Êàª„Çã",
        time_per_q: "1Âïè„ÅÇ„Åü„Çä„ÅÆÊôÇÈñìÔºàÁßíÔºâ",
        choose_difficulty: "Èõ£ÊòìÂ∫¶„ÇíÈÅ∏Êäû",
        d_very_easy: "„Å®„Å¶„ÇÇÊòì„Åó„ÅÑ",
        d_easy: "Êòì„Åó„ÅÑ",
        d_medium: "ÊôÆÈÄö",
        d_hard: "Èõ£„Åó„ÅÑ",
        d_very_hard: "„Å®„Å¶„ÇÇÈõ£„Åó„ÅÑ",
        d_impossible: "‰∏çÂèØËÉΩ",
        start_game: "„Ç≤„Éº„É†ÈñãÂßã",
        guest: "„Ç≤„Çπ„Éà",
        sign_in: "Google„Åß„É≠„Ç∞„Ç§„É≥",
        sign_out: "„É≠„Ç∞„Ç¢„Ç¶„Éà",
        correct: "Ê≠£Ëß£ÔºÅ",
        wrong: "‰∏çÊ≠£Ëß£ÔºÅ Ê≠£Ëß£Ôºö",
        time_up: "ÊôÇÈñìÂàá„ÇåÔºÅ Ê≠£Ëß£Ôºö",
        game_over: "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº",
        record_saved: "Êñ∞Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ"
      },
      fr: {
        app_title: "Maths Express",
        settings: "Param√®tres",
        language: "Langue",
        theme: "Th√®me",
        light: "Clair",
        dark: "Sombre",
        save: "Enregistrer",
        cancel: "Annuler",
        choose_mode_title: "Choisir un mode",
        mode_pow_title: "Exponentiation rapide",
        mode_pow_desc: "Calculez des puissances √† toute vitesse.",
        mode_coming: "Autres modes (bient√¥t)",
        mode_coming_desc: "Table de multiplication, racines, mix, etc.",
        coming_soon: "Bient√¥t",
        play: "Jouer",
        best_scores_title: "Meilleurs scores par difficult√©",
        difficulty: "Difficult√©",
        best_score: "Record",
        by_user: "Utilisateur",
        back: "Retour",
        time_per_q: "Temps par question (s)",
        choose_difficulty: "Choisir la difficult√©",
        d_very_easy: "Tr√®s facile",
        d_easy: "Facile",
        d_medium: "Moyen",
        d_hard: "Difficile",
        d_very_hard: "Tr√®s difficile",
        d_impossible: "Impossible",
        start_game: "D√©marrer",
        guest: "Invit√©",
        sign_in: "Se connecter avec Google",
        sign_out: "Se d√©connecter",
        correct: "Correct !",
        wrong: "Faux ! R√©ponse : ",
        time_up: "Temps √©coul√© ! R√©ponse : ",
        game_over: "Fin de partie",
        record_saved: "Nouveau record enregistr√© !"
      },
      es: {
        app_title: "Matem√°ticas R√°pidas",
        settings: "Ajustes",
        language: "Idioma",
        theme: "Tema",
        light: "Claro",
        dark: "Oscuro",
        save: "Guardar",
        cancel: "Cancelar",
        choose_mode_title: "Elige un modo",
        mode_pow_title: "Exponenciaci√≥n r√°pida",
        mode_pow_desc: "Resuelve potencias a contrarreloj.",
        mode_coming: "M√°s modos (pronto)",
        mode_coming_desc: "Tablas, ra√≠ces, ejercicios mixtos, etc.",
        coming_soon: "Pronto",
        play: "Jugar",
        best_scores_title: "Mejores puntajes por dificultad",
        difficulty: "Dificultad",
        best_score: "R√©cord",
        by_user: "Usuario",
        back: "Atr√°s",
        time_per_q: "Tiempo por pregunta (seg)",
        choose_difficulty: "Elige la dificultad",
        d_very_easy: "Muy f√°cil",
        d_easy: "F√°cil",
        d_medium: "Media",
        d_hard: "Dif√≠cil",
        d_very_hard: "Muy dif√≠cil",
        d_impossible: "Imposible",
        start_game: "Iniciar",
        guest: "Invitado",
        sign_in: "Iniciar con Google",
        sign_out: "Cerrar sesi√≥n",
        correct: "¬°Correcto!",
        wrong: "¬°Incorrecto! Respuesta: ",
        time_up: "¬°Tiempo! Respuesta: ",
        game_over: "Juego terminado",
        record_saved: "¬°Nuevo r√©cord guardado!"
      },
      pt: {
        app_title: "Matem√°tica R√°pida",
        settings: "Configura√ß√µes",
        language: "Idioma",
        theme: "Tema",
        light: "Claro",
        dark: "Escuro",
        save: "Salvar",
        cancel: "Cancelar",
        choose_mode_title: "Escolha um modo",
        mode_pow_title: "Exponencia√ß√£o r√°pida",
        mode_pow_desc: "Resolva pot√™ncias contra o tempo.",
        mode_coming: "Mais modos (em breve)",
        mode_coming_desc: "Tabuada, ra√≠zes, exerc√≠cios mistos, etc.",
        coming_soon: "Em breve",
        play: "Jogar",
        best_scores_title: "Melhores pontua√ß√µes por dificuldade",
        difficulty: "Dificuldade",
        best_score: "Recorde",
        by_user: "Usu√°rio",
        back: "Voltar",
        time_per_q: "Tempo por pergunta (s)",
        choose_difficulty: "Escolha a dificuldade",
        d_very_easy: "Muito f√°cil",
        d_easy: "F√°cil",
        d_medium: "M√©dio",
        d_hard: "Dif√≠cil",
        d_very_hard: "Muito dif√≠cil",
        d_impossible: "Imposs√≠vel",
        start_game: "Iniciar jogo",
        guest: "Convidado",
        sign_in: "Entrar com Google",
        sign_out: "Sair",
        correct: "Correto!",
        wrong: "Errado! Resposta: ",
        time_up: "Tempo esgotado! Resposta: ",
        game_over: "Fim de jogo",
        record_saved: "Novo recorde salvo!"
      },
      ar: {
        app_title: "ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ©",
        settings: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™",
        language: "ÿßŸÑŸÑÿ∫ÿ©",
        theme: "ÿßŸÑÿ≥ŸÖÿ©",
        light: "ŸÅÿßÿ™ÿ≠",
        dark: "ÿØÿßŸÉŸÜ",
        save: "ÿ≠ŸÅÿ∏",
        cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
        choose_mode_title: "ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ∂ÿπ",
        mode_pow_title: "ÿßŸÑÿ£ÿ≥ÿ≥ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ©",
        mode_pow_desc: "ÿßÿ≠ÿ≥ÿ® ÿßŸÑŸÇŸàŸâ ÿ®ÿ≥ÿ±ÿπÿ© ŸÖÿπ ÿßŸÑÿ≤ŸÖŸÜ.",
        mode_coming: "ÿ£Ÿàÿ∂ÿßÿπ ÿ£ÿÆÿ±Ÿâ (ŸÇÿ±Ÿäÿ®ÿßŸã)",
        mode_coming_desc: "ÿ¨ÿØŸàŸÑ ÿßŸÑÿ∂ÿ±ÿ®ÿå ÿßŸÑÿ¨ÿ∞Ÿàÿ±ÿå ÿ™ŸÖÿßÿ±ŸäŸÜ ŸÖÿ™ŸÜŸàÿπÿ©ÿå Ÿàÿ∫Ÿäÿ±Ÿáÿß.",
        coming_soon: "ŸÇÿ±Ÿäÿ®ÿßŸã",
        play: "ÿßÿ®ÿØÿ£",
        best_scores_title: "ÿ£ŸÅÿ∂ŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿ≠ÿ≥ÿ® ÿßŸÑÿµÿπŸàÿ®ÿ©",
        difficulty: "ÿßŸÑÿµÿπŸàÿ®ÿ©",
        best_score: "ÿ£ŸÅÿ∂ŸÑ ŸÜÿ™Ÿäÿ¨ÿ©",
        by_user: "ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ",
        back: "ÿ±ÿ¨Ÿàÿπ",
        time_per_q: "ÿßŸÑŸàŸÇÿ™ ŸÑŸÉŸÑ ÿ≥ÿ§ÿßŸÑ (ÿ´)",
        choose_difficulty: "ÿßÿÆÿ™ÿ± ÿßŸÑÿµÿπŸàÿ®ÿ©",
        d_very_easy: "ÿ≥ŸáŸÑ ÿ¨ÿØÿßŸã",
        d_easy: "ÿ≥ŸáŸÑ",
        d_medium: "ŸÖÿ™Ÿàÿ≥ÿ∑",
        d_hard: "ÿµÿπÿ®",
        d_very_hard: "ÿµÿπÿ® ÿ¨ÿØÿßŸã",
        d_impossible: "ŸÖÿ≥ÿ™ÿ≠ŸäŸÑ",
        start_game: "ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ©",
        guest: "ÿ∂ŸäŸÅ",
        sign_in: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿπÿ®ÿ± Google",
        sign_out: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
        correct: "ÿµÿ≠Ÿäÿ≠!",
        wrong: "ÿÆÿ∑ÿ£! ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: ",
        time_up: "ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™! ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: ",
        game_over: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©",
        record_saved: "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ±ŸÇŸÖ ŸÇŸäÿßÿ≥Ÿä ÿ¨ÿØŸäÿØ!"
      },
      hi: {
        app_title: "‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ó‡§£‡§ø‡§§",
        settings: "‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏",
        language: "‡§≠‡§æ‡§∑‡§æ",
        theme: "‡§•‡•Ä‡§Æ",
        light: "‡§≤‡§æ‡§á‡§ü",
        dark: "‡§°‡§æ‡§∞‡•ç‡§ï",
        save: "‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç",
        cancel: "‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
        choose_mode_title: "‡§Æ‡•ã‡§° ‡§ö‡•Å‡§®‡•á‡§Ç",
        mode_pow_title: "‡§§‡•á‡§ú‡§º ‡§ò‡§æ‡§§‡§æ‡§Ç‡§ï",
        mode_pow_desc: "‡§∏‡§Æ‡§Ø ‡§ï‡•á ‡§ñ‡§ø‡§≤‡§æ‡§´ ‡§§‡•á‡§ú‡•Ä ‡§∏‡•á ‡§ò‡§æ‡§§ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç‡•§",
        mode_coming: "‡§î‡§∞ ‡§Æ‡•ã‡§° (‡§ú‡§≤‡•ç‡§¶)",
        mode_coming_desc: "‡§ü‡•á‡§¨‡§≤, ‡§Æ‡•Ç‡§≤, ‡§Æ‡§ø‡§∂‡•ç‡§∞‡§ø‡§§ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§Ü‡§¶‡§ø‡•§",
        coming_soon: "‡§ú‡§≤‡•ç‡§¶",
        play: "‡§ñ‡•á‡§≤‡•á‡§Ç",
        best_scores_title: "‡§ï‡§†‡§ø‡§®‡§æ‡§à ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∏‡§∞‡•ç‡§µ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§†",
        difficulty: "‡§ï‡§†‡§ø‡§®‡§æ‡§à",
        best_score: "‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°",
        by_user: "‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ",
        back: "‡§µ‡§æ‡§™‡§∏",
        time_per_q: "‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§∏‡§Æ‡§Ø (‡§∏‡•á‡§ï)",
        choose_difficulty: "‡§ï‡§†‡§ø‡§®‡§æ‡§à ‡§ö‡•Å‡§®‡•á‡§Ç",
        d_very_easy: "‡§¨‡§π‡•Å‡§§ ‡§Ü‡§∏‡§æ‡§®",
        d_easy: "‡§Ü‡§∏‡§æ‡§®",
        d_medium: "‡§Æ‡§ß‡•ç‡§Ø‡§Æ",
        d_hard: "‡§ï‡§†‡§ø‡§®",
        d_very_hard: "‡§¨‡§π‡•Å‡§§ ‡§ï‡§†‡§ø‡§®",
        d_impossible: "‡§Ö‡§∏‡§Ç‡§≠‡§µ",
        start_game: "‡§ó‡•á‡§Æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç",
        guest: "‡§Ö‡§§‡§ø‡§•‡§ø",
        sign_in: "Google ‡§∏‡•á ‡§∏‡§æ‡§á‡§®-‡§á‡§®",
        sign_out: "‡§∏‡§æ‡§á‡§®-‡§Ü‡§â‡§ü",
        correct: "‡§∏‡§π‡•Ä!",
        wrong: "‡§ó‡§≤‡§§! ‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞: ",
        time_up: "‡§∏‡§Æ‡§Ø ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§! ‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞: ",
        game_over: "‡§ó‡•á‡§Æ ‡§ì‡§µ‡§∞",
        record_saved: "‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡•á‡§µ!"
      }
    };

    function applyI18n(lang){
      const dict = i18n[lang] || i18n['ru'];
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if(dict[key]) el.textContent = dict[key];
      });
      document.title = `‚ö° ${dict.app_title} ‚ö°`;
      document.getElementById("authBtn").textContent = auth.currentUser ? dict.sign_out : dict.sign_in;
      document.getElementById("userTag").textContent = auth.currentUser ? (auth.currentUser.displayName || "User") : dict.guest;
      // Update options text inside select
      const map = {
        very_easy: 'd_very_easy',
        easy: 'd_easy',
        medium: 'd_medium',
        hard: 'd_hard',
        very_hard: 'd_very_hard',
        impossible: 'd_impossible'
      };
      Object.entries(map).forEach(([val,key]) => {
        const opt = document.querySelector(`#difficulty option[value="${val}"]`);
        if(opt && dict[key]) opt.textContent = dict[key];
      });
      // table headers etc already updated via data-i18n
    }

    const storage = {
      get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback } catch{ return fallback } },
      set(key, value){ localStorage.setItem(key, JSON.stringify(value)) }
    };

    const PREF_KEY = "smath:prefs";
    const SCORES_KEY = "smath:scores"; // local fallback
    const prefs = storage.get(PREF_KEY, { theme:"dark", lang:"ru" });

    // Apply theme and language from prefs
    document.body.setAttribute("data-theme", prefs.theme || "dark");
    document.getElementById("year").textContent = new Date().getFullYear();

    // Views
    const homeView = document.getElementById("homeView");
    const powView = document.getElementById("powView");
    const openPowMode = document.getElementById("openPowMode");
    const backHome = document.getElementById("backHome");
    const authBtn = document.getElementById("authBtn");
    const userTag = document.getElementById("userTag");

    // Settings modal
    const settingsModal = document.getElementById("settingsModal");
    const openSettings = document.getElementById("openSettings");
    const closeSettings = document.getElementById("closeSettings");
    const saveSettings = document.getElementById("saveSettings");
    const languageSel = document.getElementById("language");
    const themeSel = document.getElementById("theme");

    // Game controls
    const startBtn = document.getElementById("startBtn");
    const difficultySel = document.getElementById("difficulty");
    const difficultyLabel = document.getElementById("difficultyLabel");
    const questionEl = document.getElementById("question");
    const answerEl = document.getElementById("answer");
    const timerEl = document.getElementById("timer");
    const scoreEl = document.getElementById("score");
    const msgEl = document.getElementById("message");
    const timeLimitInput = document.getElementById("timeLimit");
    const bestTableBody = document.querySelector("#bestTable tbody");
    const currentDiffTag = document.getElementById("currentDiffTag");

    languageSel.value = prefs.lang || "ru";
    themeSel.value = prefs.theme || "dark";
    applyI18n(languageSel.value);

    // Difficulty descriptions (tooltips)
    const diffDesc = {
      very_easy: "1‚Äì10 –≤ —Å—Ç–µ–ø–µ–Ω—å 2",
      easy: "1‚Äì10 –≤ —Å—Ç–µ–ø–µ–Ω–∏ 2,3,4",
      medium: "1‚Äì10 –≤ —Å—Ç–µ–ø–µ–Ω—å 2‚Ä¶10",
      hard: "1‚Äì20 –≤ —Å—Ç–µ–ø–µ–Ω—å 2‚Ä¶10",
      very_hard: "10‚Äì100 –≤ —Å—Ç–µ–ø–µ–Ω—å 2‚Ä¶100",
      impossible: "100‚Äì999 –≤ —Å—Ç–µ–ø–µ–Ω—å 2‚Ä¶100"
    };
    function updateDifficultyTooltip(){
      const tip = difficultySel.selectedOptions[0]?.getAttribute("data-tip") || "";
      difficultyLabel.setAttribute("data-tip", tip);
      currentDiffTag.textContent = difficultySel.selectedOptions[0]?.textContent || "";
    }
    updateDifficultyTooltip();
    difficultySel.addEventListener("change", updateDifficultyTooltip);

    // Modal handlers
    openSettings.addEventListener("click", ()=> settingsModal.classList.add("show"));
    closeSettings.addEventListener("click", ()=> settingsModal.classList.remove("show"));
    saveSettings.addEventListener("click", ()=> {
      const lang = languageSel.value;
      const theme = themeSel.value;
      storage.set(PREF_KEY, { ...prefs, lang, theme });
      document.body.setAttribute("data-theme", theme);
      applyI18n(lang);
      settingsModal.classList.remove("show");
    });

    // Auth handlers
    authBtn.addEventListener("click", async ()=> {
      if(auth.currentUser){
        await signOut(auth);
      } else {
        try {
          const res = await signInWithPopup(auth, provider);
          // Ensure nickname exists
          if(!res.user.displayName){
            const nick = prompt("–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∏–∫ / Choose nickname");
            if(nick){
              await updateProfile(res.user, { displayName: nick });
            }
          }
        } catch (e){
          alert("Auth error: " + e.message);
        }
      }
    });

    onAuthStateChanged(auth, async (user)=>{
      const dict = i18n[languageSel.value] || i18n['ru'];
      if(user){
        userTag.textContent = user.displayName || "User";
        authBtn.textContent = dict.sign_out;
        await ensureUserDoc(user);
        await refreshBestTable(); // pull remote
      } else {
        userTag.textContent = dict.guest;
        authBtn.textContent = dict.sign_in;
        await refreshBestTable(); // local only
      }
    });

    async function ensureUserDoc(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          uid: user.uid,
          displayName: user.displayName || "",
          createdAt: Date.now()
        });
      }
    }

    const DIFF_ORDER = ["very_easy","easy","medium","hard","very_hard","impossible"];
    const DIFF_LABELS = () => {
      const d = i18n[languageSel.value] || i18n['ru'];
      return {
        very_easy: d.d_very_easy,
        easy: d.d_easy,
        medium: d.d_medium,
        hard: d.d_hard,
        very_hard: d.d_very_hard,
        impossible: d.d_impossible
      };
    };

    async function refreshBestTable(){
      const labels = DIFF_LABELS();
      const local = storage.get(SCORES_KEY, {});
      let merged = { ...local };
      // If signed-in, try merging with Firestore
      if(auth.currentUser){
        const ref = doc(db, "scores", auth.currentUser.uid);
        const snap = await getDoc(ref);
        if(snap.exists()){
          merged = { ...merged, ...(snap.data()?.pow || {}) };
        }
      }
      // Render
      bestTableBody.innerHTML = "";
      DIFF_ORDER.forEach(df => {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        td1.textContent = labels[df];
        const td2 = document.createElement("td");
        td2.className = "center mono";
        td2.textContent = merged?.[df]?.best ?? "‚Äî";
        const td3 = document.createElement("td");
        td3.className = "center";
        td3.textContent = auth.currentUser ? (auth.currentUser.displayName || "User") : (i18n[languageSel.value]?.guest || "Guest");
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
        bestTableBody.appendChild(tr);
      });
    }
    refreshBestTable();

    // Navigation
    openPowMode.addEventListener("click", ()=>{
      homeView.style.display = "none";
      powView.style.display = "block";
      answerEl.disabled = true;
      msgEl.textContent = "";
      scoreEl.textContent = "0";
      questionEl.textContent = "‚Äî";
    });
    backHome.addEventListener("click", ()=>{
      powView.style.display = "none";
      homeView.style.display = "grid";
      stopTimer();
      answerEl.disabled = true;
      msgEl.textContent = "";
      refreshBestTable();
    });

    /************ 3) GAME LOGIC (Power Mode) ************/
    let timer = null;
    let timeLeft = 0;
    let timeLimit = 20;
    let score = 0;
    let currentBase = 0;
    let currentPow = 0;

    function stopTimer(){ if(timer){ clearInterval(timer); timer = null; } }
    function startTimer(){
      stopTimer();
      timer = setInterval(() => {
        timeLeft -= 0.1;
        timerEl.textContent = `‚è± ${timeLeft.toFixed(1)}s`;
        if(timeLeft <= 0){
          stopTimer();
          const correct = Math.pow(currentBase, currentPow);
          endGame((i18n[languageSel.value]?.time_up || "Time's up! Correct answer: ") + correct);
        }
      }, 100);
    }

    function randInt(min, max){ // inclusive
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function pickTask(){
      const d = difficultySel.value;
      switch(d){
        case "very_easy":
          currentBase = randInt(1,10);
          currentPow = 2;
          break;
        case "easy":
          currentBase = randInt(1,10);
          currentPow = [2,3,4][randInt(0,2)];
          break;
        case "medium":
          currentBase = randInt(1,10);
          currentPow = randInt(2,10);
          break;
        case "hard":
          currentBase = randInt(1,20);
          currentPow = randInt(2,10);
          break;
        case "very_hard":
          currentBase = randInt(10,100);
          currentPow = randInt(2,100);
          break;
        case "impossible":
          currentBase = randInt(100,999);
          currentPow = randInt(2,100);
          break;
      }
    }

    function ask(){
      pickTask();
      questionEl.textContent = `${currentBase} ^ ${currentPow} = ?`;
      answerEl.value = "";
      answerEl.disabled = false;
      answerEl.focus();
      timeLimit = parseFloat(timeLimitInput.value) || 20;
      timeLeft = timeLimit;
      timerEl.textContent = `‚è± ${timeLeft.toFixed(1)}s`;
      startTimer();
    }

    function endGame(reasonText){
      stopTimer();
      answerEl.disabled = true;
      msgEl.innerHTML = `<span class="warn">${reasonText}</span>`;
      questionEl.textContent = i18n[languageSel.value]?.game_over || "Game Over";
      // save best
      saveBest(score);
    }

    function saveBest(sc){
      const d = difficultySel.value;
      const local = storage.get(SCORES_KEY, {});
      const prev = local?.[d]?.best ?? 0;
      if(sc > prev){
        const updated = { ...local, [d]: { best: sc, ts: Date.now() } };
        storage.set(SCORES_KEY, updated);
        msgEl.innerHTML += `<div class="ok">${i18n[languageSel.value]?.record_saved || "New record saved!"}</div>`;
      }
      // Cloud (per-user doc: scores/{uid} { pow: {difficulty: {best, ts}} })
      if(auth.currentUser){
        const ref = doc(db, "scores", auth.currentUser.uid);
        (async ()=>{
          const snap = await getDoc(ref);
          const data = snap.exists() ? (snap.data() || {}) : {};
          const remotePow = data.pow || {};
          const curBest = remotePow[d]?.best ?? 0;
          if(sc > curBest){
            const newPow = { ...remotePow, [d]: { best: sc, ts: Date.now() } };
            await setDoc(ref, { pow: newPow }, { merge: true });
          }
          await refreshBestTable();
        })();
      } else {
        refreshBestTable();
      }
    }

    answerEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        const val = Number.parseFloat(answerEl.value);
        const correct = Math.pow(currentBase, currentPow);
        if(val === correct){
          score++;
          scoreEl.textContent = String(score);
          msgEl.innerHTML = `<span class="ok">${i18n[languageSel.value]?.correct || "Correct!"}</span>`;
          ask();
        } else {
          endGame((i18n[languageSel.value]?.wrong || "Wrong! Correct answer: ") + correct);
        }
      }
    });

    startBtn.addEventListener("click", ()=>{
      score = 0;
      scoreEl.textContent = "0";
      msgEl.textContent = "";
      ask();
    });

    // Initial table render after i18n changes
    languageSel.addEventListener("change", refreshBestTable);
  </script>
</body>
</html>
