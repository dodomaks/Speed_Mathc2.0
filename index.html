
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>⚡ Скоростная Математика ⚡</title>
  <style>
    :root { --bg:#0b0c0e; --fg:#e2e8f0; --muted:#94a3b8; --accent:#22d3ee; --card:#111318; --border:#1f2937; --ok:#10b981; --danger:#ef4444; }
    [data-theme="light"]{ --bg:#fff; --fg:#0b0c0e; --muted:#374151; --accent:#2563eb; --card:#f3f4f6; --border:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;min-height:100vh;display:flex;flex-direction:column;}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:5;}
    .brand{font-weight:800;font-size:20px}
    .header-actions{display:flex;gap:10px;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg);cursor:pointer}
    .btn.primary{background:var(--accent);color:#000;border-color:var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
    main{width:min(1100px,92vw);margin:22px auto;flex:1;display:grid;gap:18px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    .mode{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;border:1px dashed var(--border)}
    .settings-fab{position:fixed;left:14px;bottom:14px;display:inline-flex;align-items:center;gap:6px;z-index:6}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:10;padding:20px}
    .modal.show{display:flex}
    .panel{width:min(720px,96vw);background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px dashed var(--border);text-align:left}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    footer{border-top:1px solid var(--border);padding:12px 18px;color:var(--muted);font-size:13px;text-align:center}
    .hidden{display:none}
    .lead-table-wrap{max-height:400px;overflow:auto}
    .select-mode {display:flex;align-items:center;gap:8px}
    .ad-placeholder{border:1px dashed var(--border);padding:12px;border-radius:8px;text-align:center;color:var(--muted)}
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="brand">⚡ <span data-i18n="app_title">Скоростная Математика</span></div>
    <div class="header-actions">
      <span id="userTag" style="padding:6px 8px;border-radius:8px;border:1px solid var(--border)"></span>
      <button id="authBtn" class="btn small">Войти через Google</button>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="homeView" class="grid">
      <div class="card">
        <h2 style="margin-top:0" data-i18n="choose_mode_title">Выберите режим</h2>
        <div style="display:grid;gap:10px">
          <div class="mode">
            <div>
              <strong data-i18n="mode_pow_title">Скоростное возведение в степень</strong>
              <div class="muted" data-i18n="mode_pow_desc">Быстро решайте степени — на время и точность.</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn primary" id="openPowMode" data-i18n="play">Играть</button>
              <button class="btn" id="openPowLeaderboard">Таблица</button>
            </div>
          </div>

          <div class="mode">
            <div>
              <strong>Умножение</strong>
              <div class="muted">Тренируйте умножение — три уровня сложности.</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="openMulMode">Играть</button>
              <button class="btn" id="openMulLeaderboard">Таблица</button>
            </div>
          </div>

          <div class="mode">
            <div>
              <strong>Дроби</strong>
              <div class="muted">Сложности как в умножении.</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="openFracMode">Играть</button>
              <button class="btn" id="openFracLeaderboard">Таблица</button>
            </div>
          </div>

          <div class="mode">
            <div>
              <strong>Корни</strong>
              <div class="muted">Извлечение корней — разные уровни.</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="openRootMode">Играть</button>
              <button class="btn" id="openRootLeaderboard">Таблица</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0" data-i18n="best_scores_title">Лучшие результаты</h3>
          <div class="select-mode">
            <label class="muted">Показывать:</label>
            <select id="bestModeSelect">
              <option value="pow">Скоростное возведение</option>
              <option value="mul">Умножение</option>
              <option value="frac">Дроби</option>
              <option value="root">Корни</option>
            </select>
          </div>
        </div>
        <div style="margin-top:10px">
          <table id="bestTable">
            <thead><tr><th>Сложность</th><th>Рекорд</th><th>Пользователь</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- POW MODE -->
    <section id="powView" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><button class="btn" id="backHome">← Назад</button></div>
        <div><span id="currentModeTitle">Скоростное возведение</span></div>
        <div><span id="currentUserTag" class="mono"></span></div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <div>
          <label>Время на вопрос (сек)</label><br>
          <input id="timeLimit" type="number" min="1" value="20" />
        </div>
        <div>
          <label>Сложность</label><br>
          <select id="difficultyPow">
            <option value="very_easy">Очень легко</option>
            <option value="easy">Легко</option>
            <option value="medium">Средне</option>
            <option value="hard">Сложно</option>
            <option value="very_hard">Очень сложно</option>
            <option value="impossible">Невозможно</option>
          </select>
        </div>
        <div>
          <button class="btn primary" id="startPow">Начать</button>
        </div>
      </div>

      <div style="text-align:center;margin-top:18px">
        <div id="question" style="font-size:40px;font-weight:700">—</div>
        <input id="answer" class="mono" type="text" placeholder="Ваш ответ" style="font-size:18px;padding:8px;margin-top:10px" disabled />
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
          <div id="timer" class="btn">⏱ 0.0s</div>
          <div id="score" class="btn">0</div>
        </div>
        <div id="message" style="margin-top:10px;color:var(--danger)"></div>
      </div>
    </section>

    <!-- MUL MODE -->
    <section id="mulView" class="card hidden">
      <div style="display:flex;justify-content:space-between">
        <button class="btn" id="backHome2">← Назад</button>
        <div>Умножение</div>
        <div></div>
      </div>
      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <div><label>Время</label><br><input id="timeLimitMul" type="number" min="1" value="20" /></div>
        <div><label>Сложность</label><br>
          <select id="difficultyMul">
            <option value="easy">Легко (1–10 × 1–10)</option>
            <option value="medium">Средний (10–100 × 10–100)</option>
            <option value="hard">Сложно (20–1000 × 20–1000)</option>
          </select>
        </div>
        <div><button class="btn primary" id="startMul">Начать</button></div>
      </div>
      <div style="text-align:center;margin-top:18px">
        <div id="questionMul" style="font-size:36px;font-weight:700">—</div>
        <input id="answerMul" class="mono" type="number" placeholder="Ваш ответ" disabled />
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:center"><div id="timerMul" class="btn">⏱ 0.0s</div><div id="scoreMul" class="btn">0</div></div>
        <div id="messageMul" style="margin-top:10px;color:var(--danger)"></div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="leaderboardView" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Таблица лидеров</h3>
        <button class="btn" id="closeLeaderboard">Закрыть</button>
      </div>
      <div style="margin-top:12px" class="lead-table-wrap">
        <table id="leaderboardTable"><thead><tr><th>Место</th><th>Пользователь</th><th>Режим</th><th>Сложность</th><th>Рекорд</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <div class="card ad-placeholder" id="adSlot">
      Рекламный слот — сюда можно вставить Google AdSense или другой рекламный код. (Требуется аккаунт AdSense)
    </div>
  </main>

  <button class="btn settings-fab" id="openSettings">⚙ Настройки</button>

  <footer>© <span id="year"></span> • Скоростная Математика</footer>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="panel">
      <h3>⚙ Настройки</h3>
      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <label>Язык</label><br>
          <select id="language"><option value="ru">Русский</option><option value="en">English</option></select>
        </div>
        <div style="flex:1">
          <label>Тема</label><br>
          <select id="theme"><option value="dark">Тёмная</option><option value="light">Светлая</option></select>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn" id="closeSettings">Отмена</button>
        <button class="btn primary" id="saveSettings">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    // --- Firebase config: вставь сюда свои данные ---
    const firebaseConfig = {
      apiKey: "AIzaSyA-GxudNQc0C_rxs7VlSTdUd032bzn1sAg",
      authDomain: "speedmach-d5c2d.firebaseapp.com",
      projectId: "speedmach-d5c2d",
      storageBucket: "speedmach-d5c2d.firebasestorage.app",
      messagingSenderId: "988036223053",
      appId: "1:988036223053:web:227243e695aa4ee1fe0c04",
	  measurementId: "G-BJ0CQNBC2T" 
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Basic i18n (kept minimal for brevity)
    const i18n = { ru: { app_title:"Скоростная Математика", play:"Играть", best_scores_title:"Лучшие результаты" }, en: { app_title:"Speed Math", play:"Play", best_scores_title:"Best scores" } };
    function applyI18n(lang){ document.querySelectorAll("[data-i18n]").forEach(el=>{ const k=el.getAttribute("data-i18n"); if(i18n[lang]&&i18n[lang][k]) el.textContent = i18n[lang][k]; }); }

    // Elements
    const yearEl = document.getElementById("year"); yearEl.textContent = new Date().getFullYear();
    const openSettings = document.getElementById("openSettings"), settingsModal = document.getElementById("settingsModal");
    const closeSettings = document.getElementById("closeSettings"), saveSettings = document.getElementById("saveSettings");
    const languageSel = document.getElementById("language"), themeSel = document.getElementById("theme");

    openSettings.addEventListener("click", ()=> settingsModal.classList.add("show"));
    closeSettings.addEventListener("click", ()=> settingsModal.classList.remove("show"));
    saveSettings.addEventListener("click", ()=> { document.body.setAttribute("data-theme", themeSel.value); settingsModal.classList.remove("show"); });

    // Auth
    const authBtn = document.getElementById("authBtn"), userTag = document.getElementById("userTag"), currentUserTag = document.getElementById("currentUserTag");
    authBtn.addEventListener("click", async ()=> {
      if(auth.currentUser) await signOut(auth);
      else {
        try {
          // Before sign-in: recommended to run App Check / ReCAPTCHA on server side.
          await signInWithPopup(auth, provider);
        } catch(e){ alert("Auth error: "+e.message); }
      }
    });

    onAuthStateChanged(auth, async (user)=> {
      if(user){ userTag.textContent = user.displayName || "User"; authBtn.textContent = "Выйти"; currentUserTag.textContent = user.displayName || ""; await ensureUserDoc(user); } else { userTag.textContent = "Гость"; authBtn.textContent="Войти через Google"; currentUserTag.textContent=""; }
      await refreshBestTable();
    });

    async function ensureUserDoc(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()) await setDoc(ref, { uid:user.uid, displayName:user.displayName||"", createdAt:Date.now() });
    }

    // Score storage keys
    const SCORES_KEY = "smath:scores";
    function storageGet(k, fallback){ try { return JSON.parse(localStorage.getItem(k)) || fallback } catch { return fallback } }
    function storageSet(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

    // Best table show by mode selector
    const bestModeSelect = document.getElementById("bestModeSelect"), bestTableBody = document.querySelector("#bestTable tbody");
    bestModeSelect.addEventListener("change", refreshBestTable);

    async function refreshBestTable(){
      const mode = bestModeSelect.value;
      const local = storageGet(SCORES_KEY, {});
      const labels = { pow:["Очень легко","Легко","Средне","Сложно","Очень сложно","Невозможно"], mul:["Легко","Средний","Сложно"], frac:["Легко","Средний","Сложно"], root:["Легко","Средний","Сложно"] };
      bestTableBody.innerHTML = "";
      if(mode === "pow"){
        const order = ["very_easy","easy","medium","hard","very_hard","impossible"];
        order.forEach(k=>{ const tr=document.createElement("tr"); const td1=document.createElement("td"); td1.textContent = (labels.pow)[order.indexOf(k)]; const td2=document.createElement("td"); td2.textContent = local?.pow?.[k]?.best ?? "—"; const td3=document.createElement("td"); td3.textContent = (auth.currentUser?auth.currentUser.displayName:"Гость"); tr.append(td1,td2,td3); bestTableBody.appendChild(tr); });
      } else {
        const arr = labels[mode] || [];
        arr.forEach((lab,i)=>{ const tr=document.createElement("tr"); const td1=document.createElement("td"); td1.textContent = lab; const td2=document.createElement("td"); td2.textContent = local?.[mode]?.[i]?.best ?? "—"; const td3=document.createElement("td"); td3.textContent = (auth.currentUser?auth.currentUser.displayName:"Гость"); tr.append(td1,td2,td3); bestTableBody.appendChild(tr); });
      }
    }

    // NAV
    const homeView = document.getElementById("homeView"), powView = document.getElementById("powView"), mulView = document.getElementById("mulView"), leaderboardView = document.getElementById("leaderboardView");
    document.getElementById("openPowMode").addEventListener("click", ()=> { homeView.classList.add("hidden"); powView.classList.remove("hidden"); });
    document.getElementById("backHome").addEventListener("click", ()=> { powView.classList.add("hidden"); homeView.classList.remove("hidden"); stopPow(); refreshBestTable(); });
    document.getElementById("openMulMode").addEventListener("click", ()=> { homeView.classList.add("hidden"); mulView.classList.remove("hidden"); });
    document.getElementById("backHome2").addEventListener("click", ()=> { mulView.classList.add("hidden"); homeView.classList.remove("hidden"); stopMul(); refreshBestTable(); });

    // Leaderboards buttons
    document.getElementById("openPowLeaderboard").addEventListener("click", ()=> openLeaderboard("pow"));
    document.getElementById("openMulLeaderboard").addEventListener("click", ()=> openLeaderboard("mul"));
    document.getElementById("openFracLeaderboard").addEventListener("click", ()=> openLeaderboard("frac"));
    document.getElementById("openRootLeaderboard").addEventListener("click", ()=> openLeaderboard("root"));
    document.getElementById("closeLeaderboard").addEventListener("click", ()=> { leaderboardView.classList.add("hidden"); homeView.classList.remove("hidden"); });

    // --- GAME LOGIC: POW ---
    let powTimer=null, powTimeLeft=0, powScore=0, currentBase=0, currentPow=0;
    const questionEl = document.getElementById("question"), answerEl = document.getElementById("answer"), timerEl = document.getElementById("timer"), scoreEl = document.getElementById("score"), messageEl = document.getElementById("message");
    const startPowBtn = document.getElementById("startPow"), difficultyPow = document.getElementById("difficultyPow"), timeLimitInput = document.getElementById("timeLimit");

    function stopPow(){ if(powTimer){ clearInterval(powTimer); powTimer=null; } }
    function startPowTimer(){ stopPow(); powTimer=setInterval(()=>{ powTimeLeft-=0.1; timerEl.textContent = `⏱ ${powTimeLeft.toFixed(1)}s`; if(powTimeLeft<=0){ stopPow(); const corr = (BigInt(currentBase) ** BigInt(currentPow)).toString(); endPow("Время вышло! Правильный ответ: "+corr); } },100); }

    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function generatePowTask(difficulty){
      // Try generating base and pow so that answer string length <= 10 (digits)
      let attempts = 0;
      while(attempts<200){
        attempts++;
        let b,p;
        if(difficulty==="very_easy"){ b=randInt(1,10); p=2; }
        else if(difficulty==="easy"){ b=randInt(1,10); p=[2,3,4][randInt(0,2)]; }
        else if(difficulty==="medium"){ b=randInt(1,10); p=randInt(2,10); }
        else if(difficulty==="hard"){ b=randInt(1,20); p=randInt(2,10); }
        else if(difficulty==="very_hard"){ b=randInt(10,200); p=randInt(2,20); }
        else { b=randInt(100,9999); p=randInt(2,8); }
        // compute as BigInt and check length
        try{
          const val = BigInt(b) ** BigInt(p);
          const s = val.toString();
          if(s.length <= 10) return {b,p,s};
        }catch(e){}
      }
      return {b:2,p:2,s:"4"};
    }

    function askPow(){
      const diff = difficultyPow.value;
      const task = generatePowTask(diff);
      currentBase = task.b; currentPow = task.p;
      questionEl.textContent = `${currentBase} ^ ${currentPow} = ?`;
      answerEl.value = ""; answerEl.disabled = false; answerEl.focus();
      powTimeLeft = parseFloat(timeLimitInput.value) || 20; timerEl.textContent = `⏱ ${powTimeLeft.toFixed(1)}s`; startPowTimer();
    }

    function endPow(reason){
      stopPow(); answerEl.disabled=true; messageEl.textContent = reason; questionEl.textContent = "Игра окончена"; savePowBest(powScore); powScore=0; scoreEl.textContent="0";
    }

    function savePowBest(sc){
      const diff = difficultyPow.value;
      const local = storageGet(SCORES_KEY, {});
      local.pow = local.pow || {};
      const prev = local.pow[diff]?.best || 0;
      if(sc > prev){ local.pow[diff] = { best: sc, ts: Date.now() }; storageSet(SCORES_KEY, local); }
      if(auth.currentUser){ setDoc(doc(db, "scores", auth.currentUser.uid), { pow: local.pow }, { merge: true }).then(()=>refreshBestTable()).catch(()=>{}); } else refreshBestTable();
    }

    answerEl.addEventListener("keydown", (e)=> {
      if(e.key === "Enter" && !answerEl.disabled){
        const user = answerEl.value.trim();
        const correct = (BigInt(currentBase) ** BigInt(currentPow)).toString();
        if(user === correct){ powScore++; scoreEl.textContent = String(powScore); messageEl.textContent = "Верно!"; askPow(); }
        else { endPow("Неверно! Правильный ответ: "+correct); }
      }
    });

    startPowBtn.addEventListener("click", ()=> { powScore=0; scoreEl.textContent="0"; messageEl.textContent=""; askPow(); });

    // --- MUL MODE ---
    let mulTimer=null, mulTimeLeft=0, mulScore=0, aMul=0,bMul=0;
    const qMul = document.getElementById("questionMul"), ansMul = document.getElementById("answerMul"), tMul = document.getElementById("timerMul"), sMul = document.getElementById("scoreMul"), msgMul = document.getElementById("messageMul");
    const startMulBtn = document.getElementById("startMul"), diffMul = document.getElementById("difficultyMul"), timeMulInput = document.getElementById("timeLimitMul");

    function stopMul(){ if(mulTimer){ clearInterval(mulTimer); mulTimer=null; } }
    function startMulTimer(){ stopMul(); mulTimer=setInterval(()=>{ mulTimeLeft-=0.1; tMul.textContent=`⏱ ${mulTimeLeft.toFixed(1)}s`; if(mulTimeLeft<=0){ stopMul(); endMul("Время вышло! Правильный ответ: "+(aMul*bMul)); } },100); }

    function pickMulTask(){
      const d = diffMul.value;
      if(d==="easy"){ aMul=randInt(1,10); bMul=randInt(1,10); }
      else if(d==="medium"){ aMul=randInt(10,100); bMul=randInt(10,100); }
      else { aMul=randInt(20,1000); bMul=randInt(20,1000); }
    }

    function askMul(){
      pickMulTask(); qMul.textContent = `${aMul} × ${bMul} = ?`; ansMul.value=""; ansMul.disabled=false; ansMul.focus(); mulTimeLeft = parseFloat(timeMulInput.value)||20; tMul.textContent=`⏱ ${mulTimeLeft.toFixed(1)}s`; startMulTimer();
    }

    function endMul(reason){
      stopMul(); ansMul.disabled=true; msgMul.textContent = reason; saveMulBest(mulScore); mulScore=0; sMul.textContent="0";
    }

    function saveMulBest(sc){
      const d = diffMul.value;
      const local = storageGet(SCORES_KEY, {});
      local.mul = local.mul || {};
      const idx = (d==="easy"?0:(d==="medium"?1:2));
      const prev = local.mul[idx]?.best || 0;
      if(sc > prev){ local.mul[idx] = { best: sc, ts: Date.now() }; storageSet(SCORES_KEY, local); }
      if(auth.currentUser){ setDoc(doc(db,"scores",auth.currentUser.uid), { mul: local.mul }, { merge: true }).then(()=>refreshBestTable()).catch(()=>{}); } else refreshBestTable();
    }

    ansMul.addEventListener("keydown", (e)=> {
      if(e.key==="Enter" && !ansMul.disabled){
        const val = Number(ansMul.value);
        if(val === aMul*bMul){ mulScore++; sMul.textContent=String(mulScore); msgMul.textContent="Верно!"; askMul(); }
        else endMul("Неверно! Правильный ответ: "+(aMul*bMul));
      }
    });

    startMulBtn.addEventListener("click", ()=> { mulScore=0; sMul.textContent="0"; msgMul.textContent=""; askMul(); });

    // --- Leaderboard view (aggregate top scores across users) ---
    async function openLeaderboard(mode){
      homeView.classList.add("hidden"); leaderboardView.classList.remove("hidden");
      const tbody = document.querySelector("#leaderboardTable tbody"); tbody.innerHTML = "";
      try{
        const col = collection(db, "scores");
        const docs = await getDocs(col);
        const rows = [];
        docs.forEach(d => {
          const data = d.data();
          const uid = d.id;
          const display = data.displayName || data.userName || uid.substring(0,6);
          if(mode === "pow" && data.pow){
            for(const [diff,obj] of Object.entries(data.pow||{})){
              rows.push({ user: display, mode: "Pow", difficulty: diff, score: obj.best || 0 });
            }
          } else if(mode === "mul" && data.mul){
            (data.mul||[]).forEach((entry,idx)=> rows.push({ user: display, mode: "Mul", difficulty: ["Легко","Средний","Сложно"][idx]||idx, score: entry?.best||0 }));
          }
        });
        rows.sort((a,b)=> (b.score||0)-(a.score||0));
        rows.slice(0,50).forEach((r,i)=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${i+1}</td><td>${r.user}</td><td>${r.mode}</td><td>${r.difficulty}</td><td class="mono">${r.score}</td>`;
          tbody.appendChild(tr);
        });
      } catch(e){
        tbody.innerHTML = `<tr><td colspan="5">Ошибка: ${e.message}</td></tr>`;
      }
    }

    // Placeholder security notes
    async function runRecaptchaBeforeAction(actionName){ return true; }

    // Initial refresh
    refreshBestTable();

    // Debug
    window._sm = { openLeaderboard, refreshBestTable };
  </script>

  <!-- ADVICE: AdSense snippet example (placeholder) -->
  <!-- To show real ads you need an AdSense account and to insert the script and ad slot from AdSense.
       Example:
       <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=YOUR_CLIENT_ID" crossorigin="anonymous"></script>
       <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-XXXX" data-ad-slot="YYYY" data-ad-format="auto"></ins>
       <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  -->
</body>
</html>
